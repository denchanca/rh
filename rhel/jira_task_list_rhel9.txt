# Jira Task List – QA & Implementation for RHEL9 Golden Images (Expanded with Troubleshooting)

## Task 1 – Artifact Preparation
- Upload all required agent binaries (CrowdStrike, Tanium, Splunk UF, etc.) to artifact storage.
- Populate `linux/catalog.json` with artifact URLs and SHA-256 hashes (mandatory).
- Run `tools/policy-guard.sh` to confirm catalog entries are HTTPS-only, SHA-256 filled, and allowlisted.
- Commit updated catalog into repo under version control.
- **Troubleshooting:**
  - If `policy-guard.sh` fails → check for missing SHA-256 or placeholder values.
  - If downloads fail in pipeline → validate proxy/firewall egress and artifact URL access.

## Task 2 – Packer Build Validation
- Review and commit packer JSON templates (`rhel9-server-lvm.json`, `rhel9-server-lvmgen1.json`).
- Run `packer validate` against each template before pipeline execution.
- Confirm builder type is `azure-arm` with `os_type=Linux` and `gen2` enabled (default).
- Dry-run provisioner scripts to confirm no syntax errors.
- **Troubleshooting:**
  - If packer fails auth → check ADO pipeline service connection or Azure credentials.
  - If VM build stalls → inspect packer logs for provisioner errors (`tail -f packer.log`).

## Task 3 – Azure DevOps Pipeline
- Import `azure-pipelines-rhel9.yml` into ADO project repo.
- Configure pipeline parameters (`useGen1`, `location`, `sigResourceGroup`, `sigName`, `imageDefinition`, `imageVersion`).
- Ensure Validate stage executes `policy-guard.sh`.
- Connect pipeline to Azure Key Vault variable group for agent IDs, bootstrap passwords, and cert values.
- Run dry-run with `useGen1=false` to confirm Gen2 image build flow.
- **Troubleshooting:**
  - If pipeline errors on packer task → confirm packer binary installed via bootstrap script.
  - If variable group not resolving → check ADO library permissions and AKV linkage.

## Task 4 – Compliance & Smoke Tests
- Deploy VM from built image (both Gen2 and Gen1 if required).
- Run `tests/linux/validate_compliance.sh` (OpenSCAP minimal profile).
- Run `tests/linux/validate_image_smoke.sh` to verify:
  - SELinux enforcing.
  - Firewalld enabled.
  - Auditd and rsyslog active.
  - Staged tools exist in `/opt/stage/Tools/`.
- **Troubleshooting:**
  - If OpenSCAP fails → check package install in prereqs and re-run with verbose flag.
  - If SELinux shows permissive → verify `10_hardening.sh` executed during build.

## Task 5 – AKV Integration (CERTLC)
- Execute Ansible `certlc_runner` role on test VM.
- Confirm AKV secret/cert fetch using Managed Identity (no credentials).
- Validate cert/key files are written with `0600` permissions.
- Upload new cert version to AKV; verify update is applied by systemd timer within 1h.
- Test fallback runner path if CERTLC zip unavailable.
- **Troubleshooting:**
  - If AKV fetch fails (401/403) → verify VM’s Managed Identity has correct RBAC roles.
  - If cert not updated → check `journalctl -u certlc-run.service` logs for errors.

## Task 6 – Ansible Post-Deploy QA
- Run `ansible/postdeploy.yml` against test VM.
- Verify environment-bound enrollments:
  - CrowdStrike agent registers only if CID provided.
  - Tanium agent connects to server only in Stage/Prod.
  - Splunk UF deploys when bootstrap password provided.
- If `enable_certlc=true`, confirm cert rotation occurs properly.
- **Troubleshooting:**
  - If agent fails to enroll → check AKV secret exists and is retrievable by MI.
  - If Ansible playbook fails mid-run → re-run with `-vvv` to pinpoint failure task.

## Task 7 – Documentation & Handoff
- Update `README_RHEL9_TURNKEY.md` with actual artifact URLs, SHA-256s, and Key Vault references.
- Update `HOWTO_RHEL9_TURNKEY.md` with any QA-specific lessons learned.
- Publish guides to Confluence/SharePoint for operator use.
- Tag images in SIG with `Lifecycle=Active`.
- Document quarterly refresh process for RHEL9 images (OS + agents + CUs).
- **Troubleshooting:**
  - If image not appearing in SIG → check pipeline publish stage logs and Azure SIG permissions.
  - If lifecycle tags not set → validate CLI commands and service principal permissions.

---
**Key QA Deliverables:**
- Validated RHEL9 Gen2 (and optional Gen1) golden images published to SIG.
- Documented compliance & smoke test results.
- Confirmed AKV integration and cert rotation operational.
- Finalized operator runbooks in Confluence/SharePoint.
